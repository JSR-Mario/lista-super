<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Shopping List</title>
    <meta name="description" content="A simple, shareable supermarket shopping list with sections">

    <style>
        /* ========================================
           CSS Variables & Design Tokens
           ======================================== */
        :root {
            /* Color palette - soft, easy on the eyes */
            --color-bg: #f8fafc;
            --color-surface: #ffffff;
            --color-primary: #6366f1;
            --color-primary-hover: #4f46e5;
            --color-primary-light: #e0e7ff;
            --color-success: #10b981;
            --color-success-hover: #059669;
            --color-danger: #ef4444;
            --color-danger-hover: #dc2626;
            --color-warning: #f59e0b;
            --color-text: #1e293b;
            --color-text-muted: #64748b;
            --color-text-light: #94a3b8;
            --color-border: #e2e8f0;
            --color-completed-bg: #f1f5f9;

            /* Section colors */
            --color-section-header: #f1f5f9;
            --color-section-border: #cbd5e1;

            /* Shared list indicator colors */
            --color-shared-badge: #fbbf24;
            --color-shared-bg: #fffbeb;

            /* Spacing */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;

            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-full: 9999px;

            /* Shadows */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);

            /* Typography */
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;

            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 200ms ease;
        }

        /* ========================================
           Base Styles & Reset
           ======================================== */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.5;
            min-height: 100vh;
            padding: var(--space-md);
            padding-bottom: calc(var(--space-xl) * 3);
        }

        /* ========================================
           Main Container
           ======================================== */
        .container {
            max-width: 520px;
            margin: 0 auto;
        }

        /* ========================================
           Header Section
           ======================================== */
        .header {
            text-align: center;
            margin-bottom: var(--space-lg);
        }

        .header h1 {
            font-size: var(--font-size-2xl);
            font-weight: 700;
            color: var(--color-text);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
        }

        .header h1::before {
            content: "ðŸ›’";
        }

        .header p {
            font-size: var(--font-size-sm);
            color: var(--color-text-muted);
        }

        /* ========================================
           Shared List Indicator
           ======================================== */
        .shared-indicator {
            display: none;
            background: var(--color-shared-bg);
            border: 1px solid var(--color-shared-badge);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-md);
            margin-bottom: var(--space-md);
            text-align: center;
            animation: slideDown 0.3s ease;
        }

        .shared-indicator.visible {
            display: block;
        }

        .shared-indicator span {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: var(--font-size-sm);
            color: #92400e;
            font-weight: 500;
        }

        .shared-indicator span::before {
            content: "ðŸ“¤";
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* ========================================
           Card Component
           ======================================== */
        .card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
        }

        .card-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--color-text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-md);
        }

        /* ========================================
           Add Section Form
           ======================================== */
        .add-section-form {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .add-section-form input {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .add-section-form input:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        /* ========================================
           Sections Container
           ======================================== */
        .sections-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-md);
        }

        /* ========================================
           Section Component
           ======================================== */
        .section {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            overflow: hidden;
            transition: box-shadow var(--transition-normal);
        }

        .section.dragging {
            box-shadow: var(--shadow-lg);
            opacity: 0.9;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-md);
            background: var(--color-section-header);
            border-bottom: 1px solid var(--color-border);
            cursor: grab;
        }

        .section-header:active {
            cursor: grabbing;
        }

        .section-drag-handle {
            color: var(--color-text-light);
            font-size: var(--font-size-lg);
            cursor: grab;
            padding: var(--space-xs);
        }

        .section-title {
            flex: 1;
            font-size: var(--font-size-base);
            font-weight: 600;
            color: var(--color-text);
        }

        .section-count {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
            background: var(--color-bg);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
        }

        .section-delete-btn {
            background: none;
            border: none;
            color: var(--color-text-light);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            font-size: var(--font-size-base);
        }

        .section-delete-btn:hover {
            color: var(--color-danger);
            background: #fee2e2;
        }

        .section-content {
            padding: var(--space-md);
        }

        /* ========================================
           Add Item Form (within section)
           ======================================== */
        .add-item-form {
            display: flex;
            gap: var(--space-sm);
            margin-bottom: var(--space-md);
        }

        .add-item-form input[type="text"] {
            flex: 1;
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            outline: none;
            transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
        }

        .add-item-form input[type="text"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        .add-item-form input[type="number"] {
            width: 60px;
            padding: var(--space-sm);
            font-size: var(--font-size-sm);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            outline: none;
            text-align: center;
        }

        .add-item-form input[type="number"]:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px var(--color-primary-light);
        }

        /* ========================================
           Recommended Items
           ======================================== */
        .recommended-items {
            margin-bottom: var(--space-md);
        }

        .recommended-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-light);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }

        .recommended-label::before {
            content: "ðŸ’¡";
        }

        .recommended-chips {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
        }

        .recommended-chip {
            background: var(--color-primary-light);
            color: var(--color-primary);
            border: none;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .recommended-chip:hover {
            background: var(--color-primary);
            color: white;
        }

        .recommended-chip.added {
            background: var(--color-completed-bg);
            color: var(--color-text-light);
            text-decoration: line-through;
            pointer-events: none;
        }

        /* ========================================
           Shopping List Items
           ======================================== */
        .shopping-list {
            list-style: none;
        }

        .shopping-list:empty::before {
            content: "No items yet. Add some above!";
            display: block;
            text-align: center;
            padding: var(--space-md);
            color: var(--color-text-light);
            font-size: var(--font-size-sm);
            font-style: italic;
        }

        .list-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-xs);
            background: var(--color-bg);
            transition: all var(--transition-fast);
            animation: fadeIn 0.2s ease;
        }

        .list-item:hover {
            box-shadow: var(--shadow-sm);
        }

        .list-item.completed {
            background: var(--color-completed-bg);
        }

        .list-item.completed .item-text {
            text-decoration: line-through;
            color: var(--color-text-light);
        }

        .list-item.completed .item-quantity {
            opacity: 0.5;
        }

        /* Custom Checkbox */
        .checkbox-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .checkbox-wrapper input {
            position: absolute;
            opacity: 0;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .checkbox-custom {
            width: 22px;
            height: 22px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            pointer-events: none;
        }

        .checkbox-wrapper input:checked+.checkbox-custom {
            background: var(--color-success);
            border-color: var(--color-success);
        }

        .checkbox-custom::after {
            content: "";
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg) scale(0);
            transition: transform var(--transition-fast);
        }

        .checkbox-wrapper input:checked+.checkbox-custom::after {
            transform: rotate(45deg) scale(1);
        }

        .item-quantity {
            background: var(--color-warning);
            color: white;
            font-size: var(--font-size-xs);
            font-weight: 700;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            min-width: 28px;
            text-align: center;
            flex-shrink: 0;
        }

        .item-text {
            flex: 1;
            font-size: var(--font-size-sm);
            color: var(--color-text);
            word-break: break-word;
        }

        .delete-btn {
            opacity: 0.4;
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            font-size: var(--font-size-base);
            line-height: 1;
            flex-shrink: 0;
        }

        .delete-btn:hover {
            opacity: 1;
            background: #fee2e2;
        }

        /* ========================================
           Buttons
           ======================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            font-weight: 600;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            min-height: 40px;
            min-width: 40px;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-success {
            background: var(--color-success);
            color: white;
        }

        .btn-success:hover {
            background: var(--color-success-hover);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-border);
            color: var(--color-text-muted);
        }

        .btn-outline:hover {
            border-color: var(--color-text-muted);
            background: var(--color-bg);
        }

        .btn-small {
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--font-size-xs);
            min-height: 32px;
        }

        /* ========================================
           Sticky Actions Bar
           ======================================== */
        .sticky-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--color-surface);
            padding: var(--space-md);
            border-top: 1px solid var(--color-border);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .sticky-actions-inner {
            max-width: 520px;
            margin: 0 auto;
            display: flex;
            gap: var(--space-sm);
        }

        .sticky-actions .btn {
            flex: 1;
        }

        /* ========================================
           Empty State
           ======================================== */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--color-text-light);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: var(--space-md);
        }

        .empty-state p {
            margin-bottom: var(--space-md);
        }

        /* ========================================
           Toast Notification
           ======================================== */
        .toast {
            position: fixed;
            bottom: calc(var(--space-lg) + 70px);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--color-text);
            color: white;
            padding: var(--space-sm) var(--space-lg);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: 500;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
            text-align: center;
            max-width: calc(100% - 2rem);
        }

        .toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* ========================================
           Responsive Adjustments
           ======================================== */
        @media (max-width: 400px) {
            body {
                padding: var(--space-sm);
                padding-bottom: calc(var(--space-xl) * 3);
            }

            .section-content {
                padding: var(--space-sm);
            }
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Shopping List</h1>
            <p>Organize by sections â€¢ Share with family</p>
        </header>

        <!-- Shared List Indicator -->
        <div id="sharedIndicator" class="shared-indicator">
            <span>Viewing a shared list</span>
        </div>

        <!-- Add Section Card -->
        <div class="card">
            <div class="card-title">Add New Section</div>
            <form id="addSectionForm" class="add-section-form">
                <input type="text" id="sectionInput" placeholder="e.g. Frutas y Verduras..." autocomplete="off"
                    aria-label="New section name">
                <button type="submit" class="btn btn-primary">+ Section</button>
            </form>
        </div>

        <!-- Sections Container -->
        <div id="sectionsContainer" class="sections-container">
            <!-- Sections will be rendered here -->
        </div>

        <!-- Empty State (shown when no sections) -->
        <div id="emptyState" class="card empty-state">
            <div class="empty-state-icon">ðŸ“‹</div>
            <p>Start by adding a section like<br><strong>"Frutas y Verduras"</strong> or <strong>"LÃ¡cteos"</strong></p>
        </div>
    </div>

    <!-- Sticky Actions Bar -->
    <div class="sticky-actions">
        <div class="sticky-actions-inner">
            <button id="copyLinkBtn" class="btn btn-success">ðŸ“‹ Copy Link</button>
            <button id="clearCompletedBtn" class="btn btn-outline">Clear âœ“</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <script>
        /**
         * ============================================
         * SHARED SHOPPING LIST APP - Enhanced Version
         * ============================================
         * 
         * DATA STRUCTURE:
         * ---------------
         * sections = [
         *   {
         *     id: timestamp,
         *     name: "Section Name",
         *     items: [
         *       { id: timestamp, text: "Item", qty: 2, completed: false }
         *     ]
         *   }
         * ]
         * 
         * URL ENCODING:
         * -------------
         * Compact format to minimize URL length:
         * [
         *   { n: "Section", i: [{ t: "Item", q: 2, c: false }] }
         * ]
         * 
         * n = name, i = items, t = text, q = quantity, c = completed
         */

        // ============================================
        // Recommended Items by Section Type
        // ============================================
        /**
         * Recommended items are matched by section name keywords.
         * This makes it easy for users to quickly add common items.
         */
        const RECOMMENDED_ITEMS = {
            // Spanish keywords
            'frutas': ['ðŸŽ Manzanas', 'ðŸŒ PlÃ¡tanos', 'ðŸŠ Naranjas', 'ðŸ‹ Limones', 'ðŸ‡ Uvas', 'ðŸ“ Fresas', 'ðŸ¥‘ Aguacate', 'ðŸ‰ SandÃ­a'],
            'verduras': ['ðŸ¥¬ Lechuga', 'ðŸ… Tomates', 'ðŸ¥• Zanahorias', 'ðŸ¥’ Pepino', 'ðŸ§… Cebolla', 'ðŸ§„ Ajo', 'ðŸ¥” Papas', 'ðŸŒ¶ï¸ Chile'],
            'lacteos': ['ðŸ¥› Leche', 'ðŸ§€ Queso', 'ðŸ§ˆ Mantequilla', 'ðŸ¥š Huevos', 'ðŸ¦ Yogurt', 'ðŸ¶ Crema'],
            'lÃ¡cteos': ['ðŸ¥› Leche', 'ðŸ§€ Queso', 'ðŸ§ˆ Mantequilla', 'ðŸ¥š Huevos', 'ðŸ¦ Yogurt', 'ðŸ¶ Crema'],
            'carnes': ['ðŸ¥© Res', 'ðŸ— Pollo', 'ðŸ¥“ Tocino', 'ðŸŒ­ Salchichas', 'ðŸ– Cerdo', 'ðŸŸ Pescado'],
            'panaderia': ['ðŸž Pan', 'ðŸ¥ Croissants', 'ðŸ¥¯ Bagels', 'ðŸ§ Muffins', 'ðŸ© Donas'],
            'panaderÃ­a': ['ðŸž Pan', 'ðŸ¥ Croissants', 'ðŸ¥¯ Bagels', 'ðŸ§ Muffins', 'ðŸ© Donas'],
            'bebidas': ['ðŸ’§ Agua', 'ðŸ§ƒ Jugo', 'â˜• CafÃ©', 'ðŸµ TÃ©', 'ðŸ¥¤ Refrescos', 'ðŸº Cerveza'],
            'limpieza': ['ðŸ§¹ Escoba', 'ðŸ§½ Esponjas', 'ðŸ§´ JabÃ³n', 'ðŸ§» Papel', 'ðŸ§¼ Detergente'],
            'personal': ['ðŸª¥ Cepillo', 'ðŸ§´ Shampoo', 'ðŸ§» Papel higiÃ©nico', 'ðŸ§¼ JabÃ³n', 'ðŸ’Š Medicinas'],
            'personales': ['ðŸª¥ Cepillo', 'ðŸ§´ Shampoo', 'ðŸ§» Papel higiÃ©nico', 'ðŸ§¼ JabÃ³n', 'ðŸ’Š Medicinas'],

            // English keywords
            'fruits': ['ðŸŽ Apples', 'ðŸŒ Bananas', 'ðŸŠ Oranges', 'ðŸ‹ Lemons', 'ðŸ‡ Grapes', 'ðŸ“ Strawberries'],
            'vegetables': ['ðŸ¥¬ Lettuce', 'ðŸ… Tomatoes', 'ðŸ¥• Carrots', 'ðŸ¥’ Cucumber', 'ðŸ§… Onions', 'ðŸ§„ Garlic'],
            'dairy': ['ðŸ¥› Milk', 'ðŸ§€ Cheese', 'ðŸ§ˆ Butter', 'ðŸ¥š Eggs', 'ðŸ¦ Yogurt', 'ðŸ¶ Cream'],
            'meat': ['ðŸ¥© Beef', 'ðŸ— Chicken', 'ðŸ¥“ Bacon', 'ðŸŒ­ Sausages', 'ðŸŸ Fish'],
            'bakery': ['ðŸž Bread', 'ðŸ¥ Croissants', 'ðŸ¥¯ Bagels', 'ðŸ§ Muffins'],
            'drinks': ['ðŸ’§ Water', 'ðŸ§ƒ Juice', 'â˜• Coffee', 'ðŸµ Tea', 'ðŸ¥¤ Soda'],
            'cleaning': ['ðŸ§¹ Broom', 'ðŸ§½ Sponges', 'ðŸ§´ Soap', 'ðŸ§» Paper towels', 'ðŸ§¼ Detergent'],
            'snacks': ['ðŸª Cookies', 'ðŸ« Chocolate', 'ðŸ¥œ Nuts', 'ðŸ¿ Popcorn', 'ðŸ§€ Crackers'],
            'frozen': ['ðŸ¦ Ice cream', 'ðŸ¥Ÿ Dumplings', 'ðŸ• Pizza', 'ðŸ¥¦ Frozen veggies'],
            'condiments': ['ðŸ§‚ Salt', 'ðŸ«’ Olive oil', 'ðŸ¯ Honey', 'ðŸ¥« Ketchup', 'ðŸŒ¶ï¸ Hot sauce']
        };

        /**
         * Get recommended items for a section based on its name.
         * Matches keywords in the section name.
         */
        function getRecommendedItems(sectionName) {
            const nameLower = sectionName.toLowerCase();

            for (const [keyword, items] of Object.entries(RECOMMENDED_ITEMS)) {
                if (nameLower.includes(keyword)) {
                    return items;
                }
            }

            return [];
        }

        // ============================================
        // DOM Element References
        // ============================================
        const addSectionForm = document.getElementById('addSectionForm');
        const sectionInput = document.getElementById('sectionInput');
        const sectionsContainer = document.getElementById('sectionsContainer');
        const emptyState = document.getElementById('emptyState');
        const copyLinkBtn = document.getElementById('copyLinkBtn');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        const sharedIndicator = document.getElementById('sharedIndicator');
        const toast = document.getElementById('toast');

        // ============================================
        // Application State
        // ============================================
        let sections = [];
        let isSharedList = false;
        let draggedSection = null;

        // ============================================
        // URL Encoding/Decoding Functions
        // ============================================

        function encodeListToBase64(data) {
            // Convert to compact format
            const compact = data.map(section => ({
                n: section.name,
                i: section.items.map(item => ({
                    t: item.text,
                    q: item.qty,
                    c: item.completed
                }))
            }));

            const json = JSON.stringify(compact);
            return btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (_, p1) =>
                String.fromCharCode(parseInt(p1, 16))
            ));
        }

        function decodeBase64ToList(base64) {
            try {
                const json = decodeURIComponent(
                    atob(base64).split('').map(c =>
                        '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)
                    ).join('')
                );

                const compact = JSON.parse(json);

                if (!Array.isArray(compact)) return null;

                return compact.map((section, sIndex) => ({
                    id: Date.now() + sIndex,
                    name: String(section.n || '').trim(),
                    items: (section.i || []).map((item, iIndex) => ({
                        id: Date.now() + sIndex * 1000 + iIndex,
                        text: String(item.t || '').trim(),
                        qty: Math.max(1, parseInt(item.q) || 1),
                        completed: Boolean(item.c)
                    })).filter(item => item.text.length > 0)
                })).filter(section => section.name.length > 0);

            } catch (error) {
                console.error('Failed to decode list from URL:', error);
                return null;
            }
        }

        function updateURL() {
            if (sections.length === 0) {
                history.replaceState(null, '', window.location.pathname);
            } else {
                const encoded = encodeListToBase64(sections);
                history.replaceState(null, '', '#' + encoded);
            }
        }

        function loadFromURL() {
            const hash = window.location.hash.slice(1);
            if (!hash) return false;

            const decoded = decodeBase64ToList(hash);
            if (decoded && decoded.length > 0) {
                sections = decoded;
                return true;
            }
            return false;
        }

        // ============================================
        // UI Rendering Functions
        // ============================================

        function renderSections() {
            sectionsContainer.innerHTML = '';

            // Show/hide empty state
            emptyState.style.display = sections.length === 0 ? 'block' : 'none';

            sections.forEach((section, index) => {
                const sectionEl = createSectionElement(section, index);
                sectionsContainer.appendChild(sectionEl);
            });
        }

        function createSectionElement(section, index) {
            const div = document.createElement('div');
            div.className = 'section';
            div.dataset.id = section.id;
            div.draggable = true;

            // Calculate counts
            const total = section.items.length;
            const completed = section.items.filter(i => i.completed).length;
            const countText = total === 0 ? 'empty' :
                completed === 0 ? `${total} items` :
                    `${completed}/${total} done`;

            // Get recommended items for this section
            const recommended = getRecommendedItems(section.name);
            const existingItems = section.items.map(i => i.text.toLowerCase());

            div.innerHTML = `
                <div class="section-header">
                    <span class="section-drag-handle" title="Drag to reorder">â‹®â‹®</span>
                    <span class="section-title">${escapeHtml(section.name)}</span>
                    <span class="section-count">${countText}</span>
                    <button class="section-delete-btn" data-section-id="${section.id}" title="Delete section">Ã—</button>
                </div>
                <div class="section-content">
                    <form class="add-item-form" data-section-id="${section.id}">
                        <input type="number" min="1" value="1" class="item-qty-input" aria-label="Quantity">
                        <input type="text" placeholder="Add item..." class="item-text-input" autocomplete="off" aria-label="Item name">
                        <button type="submit" class="btn btn-primary btn-small">+</button>
                    </form>
                    ${recommended.length > 0 ? `
                        <div class="recommended-items">
                            <div class="recommended-label">Quick add:</div>
                            <div class="recommended-chips">
                                ${recommended.map(item => {
                const isAdded = existingItems.some(existing =>
                    existing.includes(item.toLowerCase().replace(/^[^\w]+/, '').trim()) ||
                    item.toLowerCase().includes(existing)
                );
                return `<button type="button" class="recommended-chip ${isAdded ? 'added' : ''}" 
                                        data-section-id="${section.id}" 
                                        data-item="${escapeHtml(item)}">${item}</button>`;
            }).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <ul class="shopping-list" data-section-id="${section.id}">
                        ${section.items.map(item => createItemHTML(item, section.id)).join('')}
                    </ul>
                </div>
            `;

            // Add drag event listeners
            div.addEventListener('dragstart', handleDragStart);
            div.addEventListener('dragend', handleDragEnd);
            div.addEventListener('dragover', handleDragOver);
            div.addEventListener('drop', handleDrop);

            return div;
        }

        function createItemHTML(item, sectionId) {
            return `
                <li class="list-item ${item.completed ? 'completed' : ''}" data-id="${item.id}">
                    <label class="checkbox-wrapper">
                        <input type="checkbox" ${item.completed ? 'checked' : ''} 
                            data-section-id="${sectionId}" 
                            data-item-id="${item.id}"
                            aria-label="Mark ${item.text} as complete">
                        <span class="checkbox-custom"></span>
                    </label>
                    <span class="item-quantity">${item.qty}</span>
                    <span class="item-text">${escapeHtml(item.text)}</span>
                    <button class="delete-btn" 
                        data-section-id="${sectionId}" 
                        data-item-id="${item.id}"
                        aria-label="Delete ${item.text}">Ã—</button>
                </li>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSharedIndicator(show) {
            sharedIndicator.classList.toggle('visible', show);
        }

        // ============================================
        // Drag and Drop for Section Reordering
        // ============================================

        function handleDragStart(e) {
            draggedSection = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedSection = null;
            document.querySelectorAll('.section').forEach(s => s.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';

            if (this !== draggedSection) {
                this.classList.add('drag-over');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            this.classList.remove('drag-over');

            if (draggedSection && this !== draggedSection) {
                const fromId = parseInt(draggedSection.dataset.id);
                const toId = parseInt(this.dataset.id);

                const fromIndex = sections.findIndex(s => s.id === fromId);
                const toIndex = sections.findIndex(s => s.id === toId);

                if (fromIndex !== -1 && toIndex !== -1) {
                    const [removed] = sections.splice(fromIndex, 1);
                    sections.splice(toIndex, 0, removed);
                    renderSections();
                    updateURL();
                    showToast('Section reordered');
                }
            }
        }

        // ============================================
        // Section Management
        // ============================================

        function addSection(name) {
            const trimmedName = name.trim();
            if (!trimmedName) {
                showToast('Please enter a section name');
                return;
            }

            const exists = sections.some(s =>
                s.name.toLowerCase() === trimmedName.toLowerCase()
            );

            if (exists) {
                showToast('This section already exists');
                return;
            }

            sections.push({
                id: Date.now(),
                name: trimmedName,
                items: []
            });

            renderSections();
            updateURL();
            sectionInput.value = '';
            showToast(`Added "${trimmedName}" section`);
        }

        function deleteSection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            if (section.items.length > 0) {
                if (!confirm(`Delete "${section.name}" and all its ${section.items.length} items?`)) {
                    return;
                }
            }

            sections = sections.filter(s => s.id !== sectionId);
            renderSections();
            updateURL();
            showToast(`Deleted "${section.name}"`);
        }

        // ============================================
        // Item Management
        // ============================================

        function addItem(sectionId, text, qty = 1) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            const trimmedText = text.trim();
            if (!trimmedText) {
                showToast('Please enter an item name');
                return;
            }

            const exists = section.items.some(i =>
                i.text.toLowerCase() === trimmedText.toLowerCase()
            );

            if (exists) {
                showToast('This item is already in the section');
                return;
            }

            section.items.push({
                id: Date.now(),
                text: trimmedText,
                qty: Math.max(1, parseInt(qty) || 1),
                completed: false
            });

            renderSections();
            updateURL();
        }

        function toggleItem(sectionId, itemId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            const item = section.items.find(i => i.id === itemId);
            if (item) {
                item.completed = !item.completed;
                renderSections();
                updateURL();
            }
        }

        function deleteItem(sectionId, itemId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            section.items = section.items.filter(i => i.id !== itemId);
            renderSections();
            updateURL();
        }

        function clearAllCompleted() {
            let totalCleared = 0;

            sections.forEach(section => {
                const before = section.items.length;
                section.items = section.items.filter(i => !i.completed);
                totalCleared += before - section.items.length;
            });

            if (totalCleared === 0) {
                showToast('No completed items to clear');
                return;
            }

            renderSections();
            updateURL();
            showToast(`Cleared ${totalCleared} item${totalCleared !== 1 ? 's' : ''}`);
        }

        // ============================================
        // Sharing Functions
        // ============================================

        async function copyShareLink() {
            const totalItems = sections.reduce((sum, s) => sum + s.items.length, 0);

            if (sections.length === 0 || totalItems === 0) {
                showToast('Add some items before sharing');
                return;
            }

            updateURL();

            try {
                await navigator.clipboard.writeText(window.location.href);
                showToast('Link copied! Share with family ðŸŽ‰');
            } catch (error) {
                fallbackCopyToClipboard(window.location.href);
            }
        }

        function fallbackCopyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showToast('Link copied! Share with family ðŸŽ‰');
            } catch (error) {
                showToast('Failed to copy. Try selecting URL manually.');
            }

            document.body.removeChild(textarea);
        }

        // ============================================
        // Toast Notification
        // ============================================

        let toastTimeout = null;

        function showToast(message, duration = 2500) {
            if (toastTimeout) clearTimeout(toastTimeout);

            toast.textContent = message;
            toast.classList.add('visible');

            toastTimeout = setTimeout(() => {
                toast.classList.remove('visible');
            }, duration);
        }

        // ============================================
        // Event Delegation
        // ============================================

        // Add section form
        addSectionForm.addEventListener('submit', (e) => {
            e.preventDefault();
            addSection(sectionInput.value);
        });

        // Sections container events (delegation)
        sectionsContainer.addEventListener('submit', (e) => {
            if (e.target.classList.contains('add-item-form')) {
                e.preventDefault();
                const sectionId = parseInt(e.target.dataset.sectionId);
                const textInput = e.target.querySelector('.item-text-input');
                const qtyInput = e.target.querySelector('.item-qty-input');

                addItem(sectionId, textInput.value, qtyInput.value);
                textInput.value = '';
                qtyInput.value = '1';
                textInput.focus();
            }
        });

        sectionsContainer.addEventListener('click', (e) => {
            // Delete section
            if (e.target.classList.contains('section-delete-btn')) {
                const sectionId = parseInt(e.target.dataset.sectionId);
                deleteSection(sectionId);
                return;
            }

            // Delete item
            if (e.target.classList.contains('delete-btn')) {
                const sectionId = parseInt(e.target.dataset.sectionId);
                const itemId = parseInt(e.target.dataset.itemId);
                deleteItem(sectionId, itemId);
                return;
            }

            // Recommended chip - uses the quantity from the section's qty input
            if (e.target.classList.contains('recommended-chip') && !e.target.classList.contains('added')) {
                const sectionId = parseInt(e.target.dataset.sectionId);
                const itemText = e.target.dataset.item;

                // Find the section's quantity input and get its current value
                const sectionEl = e.target.closest('.section');
                const qtyInput = sectionEl.querySelector('.item-qty-input');
                const qty = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

                addItem(sectionId, itemText, qty);

                // Reset quantity input to 1 after adding
                if (qtyInput) qtyInput.value = '1';

                return;
            }
        });

        sectionsContainer.addEventListener('change', (e) => {
            if (e.target.type === 'checkbox') {
                const sectionId = parseInt(e.target.dataset.sectionId);
                const itemId = parseInt(e.target.dataset.itemId);
                toggleItem(sectionId, itemId);
            }
        });

        // Sticky action buttons
        copyLinkBtn.addEventListener('click', copyShareLink);
        clearCompletedBtn.addEventListener('click', clearAllCompleted);

        // Hash change handler
        window.addEventListener('hashchange', () => {
            if (loadFromURL()) {
                isSharedList = true;
                showSharedIndicator(true);
            }
            renderSections();
        });

        // ============================================
        // Initialization
        // ============================================

        function init() {
            if (loadFromURL()) {
                isSharedList = true;
                showSharedIndicator(true);
                showToast('Shared list loaded! âœ¨');
            }

            renderSections();
            sectionInput.focus();
        }

        init();
    </script>
</body>

</html>